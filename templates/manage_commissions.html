{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="fa-solid fa-list-ul me-2"></i>Todos os Atendimentos</h1>
</div>

<div class="card mb-4">
    <div class="card-header"><i class="fa-solid fa-filter me-2"></i>Filtros de Pesquisa</div>
    <div class="card-body">
        <form method="GET" action="{{ url_for('manage_commissions') }}">
            <div class="row g-3 align-items-end">
                <div class="col-md-3"><label for="user_id" class="form-label">Operador</label>
                    <select name="user_id" id="user_id" class="form-select">
                        <option value="">Todos</option>
                        {% for op in operators %}<option value="{{ op.id }}" {% if filters.user_id == op.id %}selected{% endif %}>{{ op.name }}</option>{% endfor %}
                    </select>
                </div>
                <div class="col-md-3"><label for="sector" class="form-label">Setor</label>
                    <select name="sector" id="sector" class="form-select">
                        <option value="">Todos</option>
                        {% for sec in sectors %}<option value="{{ sec }}" {% if filters.sector == sec %}selected{% endif %}>{{ sec }}</option>{% endfor %}
                    </select>
                </div>
                <div class="col-md-2"><label for="start_date" class="form-label">Data Início</label><input type="date" name="start_date" id="start_date" class="form-control" value="{{ filters.start_date or '' }}"></div>
                <div class="col-md-2"><label for="end_date" class="form-label">Data Fim</label><input type="date" name="end_date" id="end_date" class="form-control" value="{{ filters.end_date or '' }}"></div>
                <div class="col-md-2">
                    <div class="d-grid gap-2"><button type="submit" class="btn btn-primary"><i class="fa-solid fa-magnifying-glass me-2"></i>Filtrar</button></div>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h3 class="h5 mb-0"><i class="fa-solid fa-database me-2"></i>Registros de Atendimento ({{ pagination.total }})</h3>
        <button type="submit" form="bulk-delete-form" class="btn btn-danger" id="bulk-delete-btn" style="display: none;">
            <i class="fa-solid fa-trash-alt me-2"></i>Remover Selecionados
        </button>
    </div>
    <div class="card-body">
        <form action="{{ url_for('delete_commission_bulk') }}" method="POST" id="bulk-delete-form" onsubmit="return confirm('Tem certeza que deseja remover todos os registros selecionados permanentemente?');">
            <div class="table-responsive">
                <table class="table table-striped table-hover table-sm">
                    <thead>
                        <tr>
                            <th><input class="form-check-input" type="checkbox" id="select-all"></th>
                            <th>Data</th>
                            <th>Operador</th>
                            <th>Setor</th>
                            <th>Subprocesso</th>
                            <th>Valor (R$)</th>
                            <th>Ação</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for commission in pagination.items %}
                        <tr>
                            <td><input class="form-check-input commission-checkbox" type="checkbox" name="commission_ids" value="{{ commission.id }}"></td>
                            <td>{{ commission.date.strftime('%d/%m/%Y %H:%M') }}</td>
                            <td>{{ commission.user.name }}</td>
                            <td>{{ commission.sector or '-' }}</td>
                            <td>{{ commission.subprocess }}</td>
                            <td>{{ "%.2f"|format(commission.value) }}</td>
                            <td>
                                <form action="{{ url_for('delete_commission', id=commission.id) }}" method="POST" class="d-inline">
                                    <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Remover este registro?')"><i class="fa-solid fa-trash"></i></button>
                                </form>
                            </td>
                        </tr>
                        {% else %}
                        <tr><td colspan="7" class="text-center">Nenhum dado encontrado para os filtros selecionados.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </form>
    </div>
    <div class="card-footer d-flex justify-content-center">
        <nav aria-label="Paginação">
            <ul class="pagination mb-0">
                <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('manage_commissions', page=pagination.prev_num, **request.args) }}">Anterior</a>
                </li>
                {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                    {% if page_num %}
                        <li class="page-item {% if pagination.page == page_num %}active{% endif %}">
                            <a class="page-link" href="{{ url_for('manage_commissions', page=page_num, **request.args) }}">{{ page_num }}</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled"><span class="page-link">...</span></li>
                    {% endif %}
                {% endfor %}
                <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('manage_commissions', page=pagination.next_num, **request.args) }}">Próxima</a>
                </li>
            </ul>
        </nav>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const selectAllCheckbox = document.getElementById('select-all');
    const commissionCheckboxes = document.querySelectorAll('.commission-checkbox');
    const bulkDeleteBtn = document.getElementById('bulk-delete-btn');

    function toggleBulkDeleteButton() {
        const anyChecked = Array.from(commissionCheckboxes).some(checkbox => checkbox.checked);
        bulkDeleteBtn.style.display = anyChecked ? 'inline-block' : 'none';
    }

    selectAllCheckbox.addEventListener('change', function () {
        commissionCheckboxes.forEach(checkbox => { checkbox.checked = selectAllCheckbox.checked; });
        toggleBulkDeleteButton();
    });

    commissionCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function () {
            if (!this.checked) { selectAllCheckbox.checked = false; }
            toggleBulkDeleteButton();
        });
    });
    toggleBulkDeleteButton();
});
</script>
{% endblock %}